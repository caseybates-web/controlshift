name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    env:
      VERSION: ''

    steps:
    - uses: actions/checkout@v4

    - name: Extract version from tag
      shell: bash
      run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_ENV"

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # Download driver installers into the Bundle project's drivers/ directory.
    - name: Download ViGEmBus
      shell: bash
      run: |
        mkdir -p src/ControlShift.Bundle/drivers
        curl -L -o src/ControlShift.Bundle/drivers/ViGEmBus_1.22.0_x64_x86_arm64.exe \
          https://github.com/nefarius/ViGEmBus/releases/download/v1.22.0/ViGEmBus_1.22.0_x64_x86_arm64.exe

    - name: Download HidHide
      shell: bash
      run: |
        curl -L -o src/ControlShift.Bundle/drivers/HidHide_1.5.230_x64.exe \
          https://github.com/nefarius/HidHide/releases/download/v1.5.230.0/HidHide_1.5.230_x64.exe

    # Build everything in one MSBuild call so inter-project references
    # (including WiX $(var.ProjectName.TargetPath) variables) resolve correctly.
    - name: Build solution
      run: >
        msbuild ControlShift.sln
        -p:Configuration=Release
        -p:Platform=x64
        -p:ProductVersion=${{ env.VERSION }}
        -restore

    - name: Prepare release asset
      shell: bash
      run: |
        cp "src/ControlShift.Bundle/bin/x64/Release/ControlShift.Bundle.exe" \
           "ControlShift-Setup-${{ env.VERSION }}.exe"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: ControlShift-Setup-${{ env.VERSION }}.exe
        generate_release_notes: true
